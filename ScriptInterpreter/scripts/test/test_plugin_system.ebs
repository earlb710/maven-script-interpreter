// EBS Language Reference v1.0.4 - See EBS_LANGUAGE_REFERENCE.md
// Test script for the external Java function plugin system

// =============================================================================
// Plugin System Test Script
// This script demonstrates loading and calling external Java functions
// =============================================================================

print "=== Testing Plugin System ===";
print "";

// -----------------------------------------------------------------------------
// Test 1: Load the built-in example plugin
// -----------------------------------------------------------------------------
print "Test 1: Loading ExampleEbsFunction plugin...";
var loadResult: bool = call plugin.load("com.eb.script.interpreter.plugin.ExampleEbsFunction", "echo");
if loadResult then {
    print "  Plugin loaded successfully!";
} else {
    print "  ERROR: Failed to load plugin";
}
print "";

// -----------------------------------------------------------------------------
// Test 2: Check if plugin is loaded
// -----------------------------------------------------------------------------
print "Test 2: Checking if 'echo' plugin is loaded...";
var isLoaded: bool = call plugin.isLoaded("echo");
print "  isLoaded('echo') = " + isLoaded;

var notLoaded: bool = call plugin.isLoaded("nonexistent");
print "  isLoaded('nonexistent') = " + notLoaded;
print "";

// -----------------------------------------------------------------------------
// Test 3: Get plugin info
// -----------------------------------------------------------------------------
print "Test 3: Getting plugin info...";
var info = call plugin.info("echo");
if info != null then {
    print "  alias: " + call json.getString(info, "alias", "");
    print "  className: " + call json.getString(info, "className", "");
    print "  name: " + call json.getString(info, "name", "");
    print "  description: " + call json.getString(info, "description", "");
}
print "";

// -----------------------------------------------------------------------------
// Test 4: Call the plugin with various arguments
// -----------------------------------------------------------------------------
print "Test 4: Calling 'echo' plugin with arguments...";

var result1 = call plugin.call("echo");
print "  echo(): " + result1;

var result2 = call plugin.call("echo", "Hello");
print "  echo('Hello'): " + result2;

var result3 = call plugin.call("echo", "Hello", "World");
print "  echo('Hello', 'World'): " + result3;

var result4 = call plugin.call("echo", "Answer:", 42, true);
print "  echo('Answer:', 42, true): " + result4;
print "";

// -----------------------------------------------------------------------------
// Test 5: List all loaded plugins
// -----------------------------------------------------------------------------
print "Test 5: Listing all loaded plugins...";
var plugins = call plugin.list();
print "  Loaded plugins: " + plugins;
print "";

// -----------------------------------------------------------------------------
// Test 6: Unload and reload with configuration
// -----------------------------------------------------------------------------
print "Test 6: Unload and reload with custom configuration...";
var unloadResult = call plugin.unload("echo");
print "  Unloaded 'echo': " + unloadResult;

// Reload with custom prefix
call plugin.load("com.eb.script.interpreter.plugin.ExampleEbsFunction", "customEcho", {"prefix": "[CUSTOM]"});
var customResult = call plugin.call("customEcho", "Test", "Message");
print "  customEcho with prefix: " + customResult;
print "";

// -----------------------------------------------------------------------------
// Test 7: Error handling - try to load non-existent class
// -----------------------------------------------------------------------------
print "Test 7: Error handling for non-existent class...";
try {
    call plugin.load("com.example.NonExistentClass", "fail");
    print "  ERROR: Should have thrown an error!";
} exceptions {
    when ANY_ERROR(msg) {
        print "  Caught expected error: " + msg;
    }
}
print "";

// -----------------------------------------------------------------------------
// Test 8: Error handling - try to call non-loaded plugin
// -----------------------------------------------------------------------------
print "Test 8: Error handling for non-loaded plugin...";
try {
    call plugin.call("nonexistent", "arg");
    print "  ERROR: Should have thrown an error!";
} exceptions {
    when ANY_ERROR(msg) {
        print "  Caught expected error: " + msg;
    }
}
print "";

// -----------------------------------------------------------------------------
// Test 9: Error handling - duplicate alias
// -----------------------------------------------------------------------------
print "Test 9: Error handling for duplicate alias...";
try {
    call plugin.load("com.eb.script.interpreter.plugin.ExampleEbsFunction", "customEcho");
    print "  ERROR: Should have thrown an error!";
} exceptions {
    when ANY_ERROR(msg) {
        print "  Caught expected error: " + msg;
    }
}
print "";

// -----------------------------------------------------------------------------
// Cleanup
// -----------------------------------------------------------------------------
print "Cleanup: Unloading all test plugins...";
call plugin.unload("customEcho");
print "  Done!";
print "";

print "=== Plugin System Tests Complete ===";
