// Test script to demonstrate bidirectional tree binding
// The tree selection updates the variable, and setting the variable updates the tree selection

// Build tree structure using json.set for proper structure
var docsChildren: array[*] = [];
var readme: json = call json.jsonFromString("{}");
readme = call json.set(readme, "value", "README.md");
call array.add(docsChildren, readme);
var todo: json = call json.jsonFromString("{}");
todo = call json.set(todo, "value", "TODO.txt");
call array.add(docsChildren, todo);
var notes: json = call json.jsonFromString("{}");
notes = call json.set(notes, "value", "Notes.md");
call array.add(docsChildren, notes);

var projectsChildren: array[*] = [];
var proj1: json = call json.jsonFromString("{}");
proj1 = call json.set(proj1, "value", "Project1");
call array.add(projectsChildren, proj1);
var proj2: json = call json.jsonFromString("{}");
proj2 = call json.set(proj2, "value", "Project2");
call array.add(projectsChildren, proj2);
var proj3: json = call json.jsonFromString("{}");
proj3 = call json.set(proj3, "value", "Project3");
call array.add(projectsChildren, proj3);

var imagesChildren: array[*] = [];
var photo1: json = call json.jsonFromString("{}");
photo1 = call json.set(photo1, "value", "photo1.jpg");
call array.add(imagesChildren, photo1);
var photo2: json = call json.jsonFromString("{}");
photo2 = call json.set(photo2, "value", "photo2.png");
call array.add(imagesChildren, photo2);

var rootChildren: array[*] = [];
var docsNode: json = call json.jsonFromString("{}");
docsNode = call json.set(docsNode, "value", "Documents");
docsNode = call json.set(docsNode, "expanded", false);
docsNode = call json.set(docsNode, "children", docsChildren);
call array.add(rootChildren, docsNode);

var projectsNode: json = call json.jsonFromString("{}");
projectsNode = call json.set(projectsNode, "value", "Projects");
projectsNode = call json.set(projectsNode, "expanded", false);
projectsNode = call json.set(projectsNode, "children", projectsChildren);
call array.add(rootChildren, projectsNode);

var imagesNode: json = call json.jsonFromString("{}");
imagesNode = call json.set(imagesNode, "value", "Images");
imagesNode = call json.set(imagesNode, "expanded", false);
imagesNode = call json.set(imagesNode, "children", imagesChildren);
call array.add(rootChildren, imagesNode);

var rootNode: json = call json.jsonFromString("{}");
rootNode = call json.set(rootNode, "value", "Root");
rootNode = call json.set(rootNode, "expanded", true);
rootNode = call json.set(rootNode, "children", rootChildren);

var treeData: array[*] = [];
call array.add(treeData, rootNode);

screen TreeBindingTest = {
    "title": "Tree Bidirectional Binding Test",
    "width": 700,
    "height": 500,
    "vars": [
        {
            "name": "selectedFile",
            "type": "string",
            "default": ""
        },
        {
            "name": "instructionsLabel",
            "type": "string",
            "default": "Test bidirectional tree binding: Click tree items OR set the variable using buttons",
            "display": {
                "type": "label",
                "itemFontSize": "14px",
                "itemBold": true
            }
        },
        {
            "name": "selectionLabel",
            "type": "string",
            "default": "Current selection: (none)",
            "display": {
                "type": "label",
                "itemFontSize": "12px"
            }
        }
    ],
    "area": [
        {
            "name": "mainArea",
            "type": "vbox",
            "items": [
                {"name": "instructionsLabel", "varRef": "instructionsLabel"},
                {"name": "selectionLabel", "varRef": "selectionLabel"},
                {
                    "name": "selectedFile", 
                    "varRef": "selectedFile",
                    "display": {
                        "type": "treeview",
                        "displayRecords": 12,
                        "showRoot": true,
                        "treeItems": [],
                        "onChange": "call scr.setProperty('TreeBindingTest.selectionLabel', 'labelText', 'Current selection: ' + selectedFile);"
                    }
                },
                {
                    "name": "selectRootBtn",
                    "display": {
                        "type": "button",
                        "labelText": "Select Root",
                        "onClick": "selectedFile = 'Root';"
                    }
                },
                {
                    "name": "selectDocBtn",
                    "display": {
                        "type": "button",
                        "labelText": "Select Documents",
                        "onClick": "selectedFile = 'Documents';"
                    }
                },
                {
                    "name": "selectReadmeBtn",
                    "display": {
                        "type": "button",
                        "labelText": "Select README.md",
                        "onClick": "selectedFile = 'README.md';"
                    }
                },
                {
                    "name": "selectProject2Btn",
                    "display": {
                        "type": "button",
                        "labelText": "Select Project2",
                        "onClick": "selectedFile = 'Project2';"
                    }
                },
                {
                    "name": "clearBtn",
                    "display": {
                        "type": "button",
                        "labelText": "Clear Selection",
                        "onClick": "selectedFile = '';"
                    }
                },
                {
                    "name": "resultsLabel",
                    "display": {
                        "type": "label",
                        "labelText": "Test: Click tree items, then click buttons to verify bidirectional binding",
                        "itemFontSize": "11px",
                        "itemItalic": true
                    }
                }
            ]
        }
    ]
};

// Inject tree items into the screen dynamically
call scr.setProperty('TreeBindingTest.selectedFile', 'treeItems', treeData);

show screen TreeBindingTest;

print "Tree Bidirectional Binding Test";
print "================================";
print "1. Click on tree items - observe the variable updates";
print "2. Click buttons to set the variable - observe the tree selection changes";
print "3. The tree should expand parent nodes and scroll to show the selected item";
