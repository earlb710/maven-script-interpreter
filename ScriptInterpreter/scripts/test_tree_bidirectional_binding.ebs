// Test script to demonstrate bidirectional tree binding
// The tree selection updates the variable, and setting the variable updates the tree selection

// Build tree structure using json.set for proper structure
var docsChildren: array[*] = [];
var readme: json = call json.jsonFromString("{}");
readme = call json.set(readme, "value", "README.md");
call array.add(docsChildren, readme);
var todo: json = call json.jsonFromString("{}");
todo = call json.set(todo, "value", "TODO.txt");
call array.add(docsChildren, todo);
var notes: json = call json.jsonFromString("{}");
notes = call json.set(notes, "value", "Notes.md");
call array.add(docsChildren, notes);

var projectsChildren: array[*] = [];
var proj1: json = call json.jsonFromString("{}");
proj1 = call json.set(proj1, "value", "Project1");
call array.add(projectsChildren, proj1);
var proj2: json = call json.jsonFromString("{}");
proj2 = call json.set(proj2, "value", "Project2");
call array.add(projectsChildren, proj2);
var proj3: json = call json.jsonFromString("{}");
proj3 = call json.set(proj3, "value", "Project3");
call array.add(projectsChildren, proj3);

var imagesChildren: array[*] = [];
var photo1: json = call json.jsonFromString("{}");
photo1 = call json.set(photo1, "value", "photo1.jpg");
call array.add(imagesChildren, photo1);
var photo2: json = call json.jsonFromString("{}");
photo2 = call json.set(photo2, "value", "photo2.png");
call array.add(imagesChildren, photo2);

var rootChildren: array[*] = [];
var docsNode: json = call json.jsonFromString("{}");
docsNode = call json.set(docsNode, "value", "Documents");
docsNode = call json.set(docsNode, "expanded", false);
docsNode = call json.set(docsNode, "children", docsChildren);
call array.add(rootChildren, docsNode);

var projectsNode: json = call json.jsonFromString("{}");
projectsNode = call json.set(projectsNode, "value", "Projects");
projectsNode = call json.set(projectsNode, "expanded", false);
projectsNode = call json.set(projectsNode, "children", projectsChildren);
call array.add(rootChildren, projectsNode);

var imagesNode: json = call json.jsonFromString("{}");
imagesNode = call json.set(imagesNode, "value", "Images");
imagesNode = call json.set(imagesNode, "expanded", false);
imagesNode = call json.set(imagesNode, "children", imagesChildren);
call array.add(rootChildren, imagesNode);

var rootNode: json = call json.jsonFromString("{}");
rootNode = call json.set(rootNode, "value", "Root");
rootNode = call json.set(rootNode, "expanded", true);
rootNode = call json.set(rootNode, "children", rootChildren);

var treeData: array[*] = [];
call array.add(treeData, rootNode);

// Create screen JSON definition
var screenJson: json = call json.jsonFromString("{}");
screenJson = call json.set(screenJson, "title", "Tree Bidirectional Binding Test");
screenJson = call json.set(screenJson, "width", 700);
screenJson = call json.set(screenJson, "height", 500);

// Build vars array
var varsArray: array[*] = [];
var selectedFileVar: json = call json.jsonFromString("{}");
selectedFileVar = call json.set(selectedFileVar, "name", "selectedFile");
selectedFileVar = call json.set(selectedFileVar, "type", "string");
selectedFileVar = call json.set(selectedFileVar, "default", "");
call array.add(varsArray, selectedFileVar);

var selectionLabelVar: json = call json.jsonFromString("{}");
selectionLabelVar = call json.set(selectionLabelVar, "name", "selectionLabel");
selectionLabelVar = call json.set(selectionLabelVar, "type", "string");
selectionLabelVar = call json.set(selectionLabelVar, "default", "No selection");
call array.add(varsArray, selectionLabelVar);

screenJson = call json.set(screenJson, "vars", varsArray);

// Build area array
var itemsArray: array[*] = [];

// Tree item
var treeItem: json = call json.jsonFromString("{}");
treeItem = call json.set(treeItem, "name", "selectedFile");
treeItem = call json.set(treeItem, "varRef", "selectedFile");
treeItem = call json.set(treeItem, "minWidth", 300);
treeItem = call json.set(treeItem, "minHeight", 400);
var treeDisplay: json = call json.jsonFromString("{}");
treeDisplay = call json.set(treeDisplay, "type", "treeview");
treeDisplay = call json.set(treeDisplay, "treeItems", []);
treeDisplay = call json.set(treeDisplay, "onChange", "selectionLabel = 'Selected: ' + selectedFile;");
treeItem = call json.set(treeItem, "display", treeDisplay);
call array.add(itemsArray, treeItem);

// Label item
var labelItem: json = call json.jsonFromString("{}");
labelItem = call json.set(labelItem, "name", "selectionLabel");
labelItem = call json.set(labelItem, "varRef", "selectionLabel");
var labelDisplay: json = call json.jsonFromString("{}");
labelDisplay = call json.set(labelDisplay, "type", "label");
labelDisplay = call json.set(labelDisplay, "itemBold", true);
labelItem = call json.set(labelItem, "display", labelDisplay);
call array.add(itemsArray, labelItem);

// Button items
var selectRootBtn: json = call json.jsonFromString("{}");
selectRootBtn = call json.set(selectRootBtn, "name", "selectRootBtn");
var selectRootDisplay: json = call json.jsonFromString("{}");
selectRootDisplay = call json.set(selectRootDisplay, "type", "button");
selectRootDisplay = call json.set(selectRootDisplay, "labelText", "Select Root");
selectRootDisplay = call json.set(selectRootDisplay, "onClick", "selectedFile = 'Root';");
selectRootBtn = call json.set(selectRootBtn, "display", selectRootDisplay);
call array.add(itemsArray, selectRootBtn);

var selectDocsBtn: json = call json.jsonFromString("{}");
selectDocsBtn = call json.set(selectDocsBtn, "name", "selectDocsBtn");
var selectDocsDisplay: json = call json.jsonFromString("{}");
selectDocsDisplay = call json.set(selectDocsDisplay, "type", "button");
selectDocsDisplay = call json.set(selectDocsDisplay, "labelText", "Select Documents");
selectDocsDisplay = call json.set(selectDocsDisplay, "onClick", "selectedFile = 'Documents';");
selectDocsBtn = call json.set(selectDocsBtn, "display", selectDocsDisplay);
call array.add(itemsArray, selectDocsBtn);

var selectReadmeBtn: json = call json.jsonFromString("{}");
selectReadmeBtn = call json.set(selectReadmeBtn, "name", "selectReadmeBtn");
var selectReadmeDisplay: json = call json.jsonFromString("{}");
selectReadmeDisplay = call json.set(selectReadmeDisplay, "type", "button");
selectReadmeDisplay = call json.set(selectReadmeDisplay, "labelText", "Select README.md");
selectReadmeDisplay = call json.set(selectReadmeDisplay, "onClick", "selectedFile = 'README.md';");
selectReadmeBtn = call json.set(selectReadmeBtn, "display", selectReadmeDisplay);
call array.add(itemsArray, selectReadmeBtn);

var selectProject2Btn: json = call json.jsonFromString("{}");
selectProject2Btn = call json.set(selectProject2Btn, "name", "selectProject2Btn");
var selectProject2Display: json = call json.jsonFromString("{}");
selectProject2Display = call json.set(selectProject2Display, "type", "button");
selectProject2Display = call json.set(selectProject2Display, "labelText", "Select Project2");
selectProject2Display = call json.set(selectProject2Display, "onClick", "selectedFile = 'Project2';");
selectProject2Btn = call json.set(selectProject2Btn, "display", selectProject2Display);
call array.add(itemsArray, selectProject2Btn);

var clearBtn: json = call json.jsonFromString("{}");
clearBtn = call json.set(clearBtn, "name", "clearBtn");
var clearDisplay: json = call json.jsonFromString("{}");
clearDisplay = call json.set(clearDisplay, "type", "button");
clearDisplay = call json.set(clearDisplay, "labelText", "Clear Selection");
clearDisplay = call json.set(clearDisplay, "onClick", "selectedFile = '';");
clearBtn = call json.set(clearBtn, "display", clearDisplay);
call array.add(itemsArray, clearBtn);

// Create main area
var mainArea: json = call json.jsonFromString("{}");
mainArea = call json.set(mainArea, "name", "mainArea");
mainArea = call json.set(mainArea, "type", "vbox");
mainArea = call json.set(mainArea, "spacing", 10);
mainArea = call json.set(mainArea, "padding", 15);
mainArea = call json.set(mainArea, "items", itemsArray);

var areaArray: array[*] = [];
call array.add(areaArray, mainArea);
screenJson = call json.set(screenJson, "area", areaArray);

// Inject treeItems into the screen JSON
var area: json = areaArray[0];
var items: json = call json.get(area, "items");
if items != null && items.length > 0 then {
    var treeItemFromArea: json = items[0];
    var display: json = call json.get(treeItemFromArea, "display");
    if display != null then {
        display = call json.set(display, "treeItems", treeData);
        treeItemFromArea = call json.set(treeItemFromArea, "display", display);
        items = call json.set(items, 0, treeItemFromArea);
        area = call json.set(area, "items", items);
        areaArray = call json.set(areaArray, 0, area);
        screenJson = call json.set(screenJson, "area", areaArray);
    }
}

// Define the screen using the modified JSON
screen TreeBindingTest = screenJson;

// Show the screen
show screen TreeBindingTest;

print "Tree Bidirectional Binding Test";
print "================================";
print "1. Click on tree items - observe the variable updates";
print "2. Click buttons to set the variable - observe the tree selection changes";
print "3. The tree should expand parent nodes and scroll to show the selected item";
