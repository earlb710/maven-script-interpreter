// Test script for direct screen variable access in thread.timer callbacks
// Tests that timer callbacks can access screen vars directly

print "=== Test: Direct Screen Variable Access in Timer Callbacks ===";
print "Testing that thread.timer callbacks can access screen vars directly";
print "";

var timerName: string = "counterTimer";

// Timer callback function that accesses screen vars directly
timerCallback(tName: string) {
    // Test direct access to screen variables without qualification
    counter = counter + 1;
    
    // Update the message with timestamp
    message = "Timer tick #" + counter + " at " + call date.format(call date.now(), "HH:mm:ss");
    
    print "Timer callback: counter=" + counter + ", message=" + message;
}

// Define a test screen with timer controls using area items
screen timerTestScreen = {
    "title": "Timer Variable Access Test (Area Items)",
    "width": 500,
    "height": 450,
    "sets": [
        {
            "setname": "main",
            "vars": [
                {"name": "counter", "type": "int", "default": 0},
                {"name": "message", "type": "string", "default": "Not started"},
                {"name": "timerInterval", "type": "int", "default": 1000}
            ]
        }
    ],
    "area": [
        {
            "name": "mainArea",
            "type": "vbox",
            "spacing": "15",
            "padding": "20",
            "style": "-fx-background-color: #f5f5f5;",
            "items": [],
            "areas": [
                {
                    "name": "headerArea",
                    "type": "vbox",
                    "spacing": "10",
                    "padding": "10",
                    "style": "-fx-background-color: #e3f2fd; -fx-border-color: #1976d2; -fx-border-width: 2; -fx-border-radius: 5;",
                    "items": [
                        {
                            "name": "titleLabel",
                            "display": {
                                "type": "label",
                                "labelText": "Timer Variable Access Test",
                                "labelColor": "#1976d2",
                                "labelFontSize": "18px",
                                "labelBold": true,
                                "style": "-fx-alignment: center;"
                            }
                        },
                        {
                            "name": "descLabel",
                            "display": {
                                "type": "label",
                                "labelText": "Tests direct screen variable access in timer callbacks using area items",
                                "labelColor": "#555555",
                                "labelFontSize": "12px",
                                "style": "-fx-alignment: center; -fx-wrap-text: true;"
                            }
                        }
                    ]
                },
                {
                    "name": "dataArea",
                    "type": "vbox",
                    "spacing": "10",
                    "padding": "10",
                    "style": "-fx-background-color: #ffffff; -fx-border-color: #cccccc; -fx-border-width: 1; -fx-border-radius: 5;",
                    "items": [
                        {
                            "name": "counterField",
                            "varRef": "counter",
                            "sequence": 1,
                            "display": {
                                "type": "textfield",
                                "labelText": "Counter:",
                                "promptHelp": "Updates automatically via timer",
                                "style": "-fx-font-size: 14px;"
                            }
                        },
                        {
                            "name": "messageField",
                            "varRef": "message",
                            "sequence": 2,
                            "display": {
                                "type": "textfield",
                                "labelText": "Message:",
                                "promptHelp": "Timer status message",
                                "style": "-fx-font-size: 14px;"
                            }
                        },
                        {
                            "name": "intervalSpinner",
                            "varRef": "timerInterval",
                            "sequence": 3,
                            "display": {
                                "type": "spinner",
                                "labelText": "Interval (ms):",
                                "min": 100,
                                "max": 5000,
                                "style": "-fx-font-size: 14px;"
                            }
                        }
                    ]
                },
                {
                    "name": "controlArea",
                    "type": "vbox",
                    "spacing": "10",
                    "padding": "10",
                    "items": [],
                    "areas": [
                        {
                            "name": "timerButtonsArea",
                            "type": "hbox",
                            "spacing": "10",
                            "alignment": "center",
                            "items": [
                                {
                                    "name": "btnStart",
                                    "display": {
                                        "type": "button",
                                        "labelText": "Start Timer",
                                        "onClick": "if (call thread.timerIsRunning(timerName)) { print 'Timer already running'; } else { call thread.timerStart(timerName, timerInterval, 'timerCallback'); message = 'Timer started'; print 'Timer started with interval: ' + timerInterval + 'ms'; }",
                                        "style": "-fx-min-width: 120px; -fx-font-size: 14px; -fx-background-color: #4caf50; -fx-text-fill: white; -fx-font-weight: bold;"
                                    }
                                },
                                {
                                    "name": "btnStop",
                                    "display": {
                                        "type": "button",
                                        "labelText": "Stop Timer",
                                        "onClick": "if (call thread.timerIsRunning(timerName)) { call thread.timerStop(timerName); message = 'Timer stopped'; print 'Timer stopped at count: ' + counter; } else { print 'Timer is not running'; }",
                                        "style": "-fx-min-width: 120px; -fx-font-size: 14px; -fx-background-color: #f44336; -fx-text-fill: white; -fx-font-weight: bold;"
                                    }
                                }
                            ]
                        },
                        {
                            "name": "actionButtonsArea",
                            "type": "hbox",
                            "spacing": "10",
                            "alignment": "center",
                            "items": [
                                {
                                    "name": "btnReset",
                                    "display": {
                                        "type": "button",
                                        "labelText": "Reset Counter",
                                        "onClick": "counter = 0; message = 'Counter reset'; print 'Counter reset to 0';",
                                        "style": "-fx-min-width: 120px; -fx-font-size: 14px; -fx-background-color: #ff9800; -fx-text-fill: white; -fx-font-weight: bold;"
                                    }
                                },
                                {
                                    "name": "btnCheckStatus",
                                    "display": {
                                        "type": "button",
                                        "labelText": "Check Status",
                                        "onClick": "var isRunning = call thread.timerIsRunning(timerName); var status = 'Timer is ' + (isRunning ? 'running' : 'stopped'); print status; print 'Current counter: ' + counter; print 'Current message: ' + message;",
                                        "style": "-fx-min-width: 120px; -fx-font-size: 14px; -fx-background-color: #2196f3; -fx-text-fill: white; -fx-font-weight: bold;"
                                    }
                                }
                            ]
                        },
                        {
                            "name": "closeButtonArea",
                            "type": "hbox",
                            "spacing": "10",
                            "alignment": "center",
                            "items": [
                                {
                                    "name": "btnClose",
                                    "display": {
                                        "type": "button",
                                        "labelText": "Close",
                                        "onClick": "if (call thread.timerIsRunning(timerName)) { call thread.timerStop(timerName); print 'Timer stopped before closing'; } close screen;",
                                        "style": "-fx-min-width: 250px; -fx-font-size: 14px; -fx-background-color: #607d8b; -fx-text-fill: white; -fx-font-weight: bold;"
                                    }
                                }
                            ]
                        }
                    ]
                }
            ]
        }
    ],
    "startup": "counter = 0; message = 'Ready to start'; print 'Startup: Screen initialized';",
    "cleanup": "if (call thread.timerIsRunning(timerName)) { call thread.timerStop(timerName); print 'Cleanup: Timer stopped'; } print 'Cleanup: Final counter value: ' + counter;"
};

// Show the screen
show screen timerTestScreen;

print "";
print "Screen displayed. Instructions:";
print "1. Click 'Start Timer' - timer will increment counter every second";
print "2. Watch the counter and message fields update automatically";
print "3. Click 'Stop Timer' - timer stops updating";
print "4. Click 'Reset Counter' - resets counter to 0";
print "5. Adjust 'Interval' spinner and restart timer to change update speed";
print "6. Click 'Check Status' - displays current timer state and values";
print "7. Click 'Close' - stops timer and closes screen";
print "";
print "Expected behavior:";
print "  - Timer callback accesses 'counter' and 'message' directly (no prefix)";
print "  - Counter increments automatically when timer is running";
print "  - Message updates with timestamp on each timer tick";
print "  - All button handlers can access and modify variables directly";
print "  - Cleanup code stops the timer and displays final counter value";
